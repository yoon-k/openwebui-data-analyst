const i18n = {
    en: {
        title: "AI Data Analyst",
        subtitle: "Upload data and get instant AI-powered insights",
        uploadPanel: "DATA SOURCE",
        uploadTitle: "Drop your file here",
        uploadSubtitle: "CSV, Excel, or JSON (max 16MB)",
        columns: "Columns",
        resultsPanel: "ANALYSIS",
        tabData: "Data",
        tabChart: "Chart",
        tabInsights: "Insights",
        tabChat: "Chat",
        rows: "Rows",
        cols: "Columns",
        memory: "Memory",
        chartType: "Chart Type",
        xAxis: "X Axis",
        yAxis: "Y Axis",
        groupBy: "Group By",
        generateChart: "Generate Chart",
        queryPlaceholder: "Ask anything about your data...",
        analyze: "Analyze",
        chatPlaceholder: "Chat about your data...",
        send: "Send",
        noData: "No Data Loaded",
        noDataDesc: "Upload a CSV, Excel, or JSON file to get started",
        generating: "Generating...",
        analyzing: "Analyzing...",
        bar: "Bar Chart", line: "Line Chart", pie: "Pie Chart", scatter: "Scatter Plot",
        histogram: "Histogram", heatmap: "Heatmap", box: "Box Plot",
        welcome: "Hello! I'm your AI data analyst. Upload a dataset and I'll help you:\n\nâ€¢ Explore and understand your data\nâ€¢ Generate visualizations\nâ€¢ Find patterns and insights\nâ€¢ Answer questions about your data",
        keyFindings: "Key Findings", recommendations: "Recommendations", anomalies: "Anomalies"
    },
    ko: {
        title: "AI ë°ì´í„° ë¶„ì„ê°€",
        subtitle: "ë°ì´í„°ë¥¼ ì—…ë¡œë“œí•˜ê³  AI ê¸°ë°˜ ì¸ì‚¬ì´íŠ¸ë¥¼ ì¦‰ì‹œ ë°›ì•„ë³´ì„¸ìš”",
        uploadPanel: "ë°ì´í„° ì†ŒìŠ¤",
        uploadTitle: "íŒŒì¼ì„ ì—¬ê¸°ì— ë†“ìœ¼ì„¸ìš”",
        uploadSubtitle: "CSV, Excel, ë˜ëŠ” JSON (ìµœëŒ€ 16MB)",
        columns: "ì»¬ëŸ¼",
        resultsPanel: "ë¶„ì„",
        tabData: "ë°ì´í„°",
        tabChart: "ì°¨íŠ¸",
        tabInsights: "ì¸ì‚¬ì´íŠ¸",
        tabChat: "ì±„íŒ…",
        rows: "í–‰",
        cols: "ì—´",
        memory: "ë©”ëª¨ë¦¬",
        chartType: "ì°¨íŠ¸ ìœ í˜•",
        xAxis: "Xì¶•",
        yAxis: "Yì¶•",
        groupBy: "ê·¸ë£¹",
        generateChart: "ì°¨íŠ¸ ìƒì„±",
        queryPlaceholder: "ë°ì´í„°ì— ëŒ€í•´ ë¬´ì—‡ì´ë“  ì§ˆë¬¸í•˜ì„¸ìš”...",
        analyze: "ë¶„ì„",
        chatPlaceholder: "ë°ì´í„°ì— ëŒ€í•´ ëŒ€í™”í•˜ì„¸ìš”...",
        send: "ì „ì†¡",
        noData: "ë°ì´í„° ì—†ìŒ",
        noDataDesc: "CSV, Excel, ë˜ëŠ” JSON íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì„¸ìš”",
        generating: "ìƒì„± ì¤‘...",
        analyzing: "ë¶„ì„ ì¤‘...",
        bar: "ë§‰ëŒ€ ì°¨íŠ¸", line: "ì„  ì°¨íŠ¸", pie: "íŒŒì´ ì°¨íŠ¸", scatter: "ì‚°ì ë„",
        histogram: "ížˆìŠ¤í† ê·¸ëž¨", heatmap: "ížˆíŠ¸ë§µ", box: "ë°•ìŠ¤ í”Œë¡¯",
        welcome: "ì•ˆë…•í•˜ì„¸ìš”! AI ë°ì´í„° ë¶„ì„ê°€ìž…ë‹ˆë‹¤. ë°ì´í„°ì…‹ì„ ì—…ë¡œë“œí•˜ë©´ ë‹¤ìŒì„ ë„ì™€ë“œë¦½ë‹ˆë‹¤:\n\nâ€¢ ë°ì´í„° íƒìƒ‰ ë° ì´í•´\nâ€¢ ì‹œê°í™” ìƒì„±\nâ€¢ íŒ¨í„´ ë° ì¸ì‚¬ì´íŠ¸ ë°œê²¬\nâ€¢ ë°ì´í„°ì— ëŒ€í•œ ì§ˆë¬¸ ë‹µë³€",
        keyFindings: "ì£¼ìš” ë°œê²¬", recommendations: "ê¶Œìž¥ ì‚¬í•­", anomalies: "ì´ìƒì¹˜"
    },
    ja: {
        title: "AIãƒ‡ãƒ¼ã‚¿ã‚¢ãƒŠãƒªã‚¹ãƒˆ",
        subtitle: "ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦AIæ­è¼‰ã®ã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚’å³åº§ã«å–å¾—",
        uploadPanel: "ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹",
        uploadTitle: "ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã“ã“ã«ãƒ‰ãƒ­ãƒƒãƒ—",
        uploadSubtitle: "CSVã€Excelã€ã¾ãŸã¯JSONï¼ˆæœ€å¤§16MBï¼‰",
        columns: "ã‚«ãƒ©ãƒ ",
        resultsPanel: "åˆ†æž",
        tabData: "ãƒ‡ãƒ¼ã‚¿",
        tabChart: "ãƒãƒ£ãƒ¼ãƒˆ",
        tabInsights: "ã‚¤ãƒ³ã‚µã‚¤ãƒˆ",
        tabChat: "ãƒãƒ£ãƒƒãƒˆ",
        rows: "è¡Œ",
        cols: "åˆ—",
        memory: "ãƒ¡ãƒ¢ãƒª",
        chartType: "ãƒãƒ£ãƒ¼ãƒˆã‚¿ã‚¤ãƒ—",
        xAxis: "Xè»¸",
        yAxis: "Yè»¸",
        groupBy: "ã‚°ãƒ«ãƒ¼ãƒ—",
        generateChart: "ãƒãƒ£ãƒ¼ãƒˆç”Ÿæˆ",
        queryPlaceholder: "ãƒ‡ãƒ¼ã‚¿ã«ã¤ã„ã¦ä½•ã§ã‚‚è³ªå•...",
        analyze: "åˆ†æž",
        chatPlaceholder: "ãƒ‡ãƒ¼ã‚¿ã«ã¤ã„ã¦ãƒãƒ£ãƒƒãƒˆ...",
        send: "é€ä¿¡",
        noData: "ãƒ‡ãƒ¼ã‚¿ãªã—",
        noDataDesc: "CSVã€Excelã€ã¾ãŸã¯JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„",
        generating: "ç”Ÿæˆä¸­...",
        analyzing: "åˆ†æžä¸­...",
        bar: "æ£’ã‚°ãƒ©ãƒ•", line: "æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•", pie: "å††ã‚°ãƒ©ãƒ•", scatter: "æ•£å¸ƒå›³",
        histogram: "ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ", heatmap: "ãƒ’ãƒ¼ãƒˆãƒžãƒƒãƒ—", box: "ç®±ã²ã’å›³",
        welcome: "ã“ã‚“ã«ã¡ã¯ï¼AIãƒ‡ãƒ¼ã‚¿ã‚¢ãƒŠãƒªã‚¹ãƒˆã§ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã¨ä»¥ä¸‹ã‚’ãŠæ‰‹ä¼ã„ã—ã¾ã™ï¼š\n\nâ€¢ ãƒ‡ãƒ¼ã‚¿ã®æŽ¢ç´¢ã¨ç†è§£\nâ€¢ å¯è¦–åŒ–ã®ç”Ÿæˆ\nâ€¢ ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã‚¤ãƒ³ã‚µã‚¤ãƒˆã®ç™ºè¦‹\nâ€¢ ãƒ‡ãƒ¼ã‚¿ã«é–¢ã™ã‚‹è³ªå•ã¸ã®å›žç­”",
        keyFindings: "ä¸»ãªç™ºè¦‹", recommendations: "æŽ¨å¥¨äº‹é …", anomalies: "ç•°å¸¸å€¤"
    }
};

let currentLang = 'en';
let currentTab = 'data';
let dataSummary = null;
let chartImage = null;
let insights = null;
let chatHistory = [];

document.addEventListener('DOMContentLoaded', () => {
    setLanguage('en');
    setupUploadZone();
    addWelcomeMessage();
});

function setLanguage(lang) {
    currentLang = lang;
    const t = i18n[lang];
    document.getElementById('title').textContent = t.title;
    document.getElementById('subtitle').textContent = t.subtitle;
    document.getElementById('uploadPanelTitle').textContent = t.uploadPanel;
    document.getElementById('uploadTitle').textContent = t.uploadTitle;
    document.getElementById('uploadSubtitle').textContent = t.uploadSubtitle;
    document.getElementById('columnsTitle').textContent = t.columns;
    document.getElementById('resultsPanelTitle').textContent = t.resultsPanel;
    document.getElementById('tabData').textContent = t.tabData;
    document.getElementById('tabChart').textContent = t.tabChart;
    document.getElementById('tabInsights').textContent = t.tabInsights;
    document.getElementById('tabChat').textContent = t.tabChat;
    document.querySelectorAll('.lang-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.lang === lang));
    updateResults();
}

function setupUploadZone() {
    const zone = document.getElementById('uploadZone');
    const input = document.getElementById('fileInput');
    zone.addEventListener('click', () => input.click());
    zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
    zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
    zone.addEventListener('drop', e => { e.preventDefault(); zone.classList.remove('dragover'); if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]); });
    input.addEventListener('change', e => { if (e.target.files.length) handleFile(e.target.files[0]); });
}

async function handleFile(file) {
    const t = i18n[currentLang];
    const formData = new FormData();
    formData.append('file', file);
    document.getElementById('fileInfo').innerHTML = `<div class="loading"><div class="spinner"></div>Loading...</div>`;
    try {
        const response = await fetch('/api/upload', { method: 'POST', body: formData });
        if (!response.ok) throw new Error('Upload failed');
        dataSummary = await response.json();
        renderFileInfo();
        renderColumnList();
        updateResults();
    } catch (error) {
        document.getElementById('fileInfo').innerHTML = `<div class="empty-state"><p>${error.message}</p></div>`;
    }
}

function renderFileInfo() {
    if (!dataSummary) return;
    const t = i18n[currentLang];
    document.getElementById('fileInfo').innerHTML = `
        <div class="file-info">
            <div class="file-name">ðŸ“„ ${dataSummary.filename}</div>
            <div class="file-meta">${dataSummary.rows} ${t.rows} â€¢ ${dataSummary.columns} ${t.cols} â€¢ ${dataSummary.memory_usage}</div>
        </div>`;
}

function renderColumnList() {
    if (!dataSummary) return;
    const list = document.getElementById('columnList');
    list.innerHTML = dataSummary.column_info.map(col => `
        <div class="column-item">
            <span class="column-name">${col.name}</span>
            <span class="column-type">${col.dtype}</span>
        </div>`).join('');
}

function showTab(tab) {
    currentTab = tab;
    document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
    updateResults();
}

function updateResults() {
    const container = document.getElementById('resultsContainer');
    const t = i18n[currentLang];
    if (!dataSummary) {
        container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">ðŸ“Š</div><h3>${t.noData}</h3><p>${t.noDataDesc}</p></div>`;
        return;
    }
    if (currentTab === 'data') renderDataTab(container, t);
    else if (currentTab === 'chart') renderChartTab(container, t);
    else if (currentTab === 'insights') renderInsightsTab(container, t);
    else if (currentTab === 'chat') renderChatTab(container, t);
}

async function renderDataTab(container, t) {
    container.innerHTML = `<div class="loading"><div class="spinner"></div>Loading...</div>`;
    try {
        const response = await fetch('/api/preview?rows=20');
        const data = await response.json();
        if (data.data && data.data.length > 0) {
            const cols = Object.keys(data.data[0]);
            container.innerHTML = `
                <div style="overflow-x:auto;">
                    <table class="data-table">
                        <thead><tr>${cols.map(c => `<th>${c}</th>`).join('')}</tr></thead>
                        <tbody>${data.data.map(row => `<tr>${cols.map(c => `<td>${row[c] ?? ''}</td>`).join('')}</tr>`).join('')}</tbody>
                    </table>
                </div>`;
        }
    } catch (error) {
        container.innerHTML = `<div class="empty-state"><p>Error loading data</p></div>`;
    }
}

function renderChartTab(container, t) {
    const numCols = dataSummary.numeric_columns || [];
    const catCols = dataSummary.categorical_columns || [];
    const allCols = [...numCols, ...catCols];
    container.innerHTML = `
        <div class="chart-options">
            <div class="chart-option"><label>${t.chartType}</label><select id="chartType">
                <option value="bar">${t.bar}</option><option value="line">${t.line}</option><option value="pie">${t.pie}</option>
                <option value="scatter">${t.scatter}</option><option value="histogram">${t.histogram}</option>
                <option value="heatmap">${t.heatmap}</option><option value="box">${t.box}</option>
            </select></div>
            <div class="chart-option"><label>${t.xAxis}</label><select id="xColumn"><option value="">-</option>${allCols.map(c => `<option value="${c}">${c}</option>`).join('')}</select></div>
            <div class="chart-option"><label>${t.yAxis}</label><select id="yColumn"><option value="">-</option>${numCols.map(c => `<option value="${c}">${c}</option>`).join('')}</select></div>
            <div class="chart-option"><label>${t.groupBy}</label><select id="groupBy"><option value="">-</option>${catCols.map(c => `<option value="${c}">${c}</option>`).join('')}</select></div>
        </div>
        <button class="btn btn-primary" style="width:100%;margin-bottom:1rem;" onclick="generateChart()">${t.generateChart}</button>
        <div id="chartContainer" class="chart-container">${chartImage ? `<img src="${chartImage}" alt="Chart">` : ''}</div>`;
}

async function generateChart() {
    const t = i18n[currentLang];
    const container = document.getElementById('chartContainer');
    container.innerHTML = `<div class="loading"><div class="spinner"></div>${t.generating}</div>`;
    try {
        const response = await fetch('/api/chart', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                chart_type: document.getElementById('chartType').value,
                x_column: document.getElementById('xColumn').value || null,
                y_column: document.getElementById('yColumn').value || null,
                group_by: document.getElementById('groupBy').value || null
            })
        });
        const data = await response.json();
        if (data.image) {
            chartImage = data.image;
            container.innerHTML = `<img src="${chartImage}" alt="Chart">`;
        } else {
            container.innerHTML = `<div class="empty-state"><p>${data.error || 'Failed to generate chart'}</p></div>`;
        }
    } catch (error) {
        container.innerHTML = `<div class="empty-state"><p>Error generating chart</p></div>`;
    }
}

async function renderInsightsTab(container, t) {
    container.innerHTML = `
        <div style="margin-bottom:1rem;">
            <input type="text" id="queryInput" class="query-input" placeholder="${t.queryPlaceholder}" onkeypress="if(event.key==='Enter')analyzeQuery()">
        </div>
        <button class="btn btn-primary" style="width:100%;margin-bottom:1rem;" onclick="analyzeQuery()">${t.analyze}</button>
        <div id="insightsContainer">${insights ? renderInsightsContent(insights, t) : ''}</div>`;
}

async function analyzeQuery() {
    const t = i18n[currentLang];
    const query = document.getElementById('queryInput').value;
    if (!query) return;
    const container = document.getElementById('insightsContainer');
    container.innerHTML = `<div class="loading"><div class="spinner"></div>${t.analyzing}</div>`;
    try {
        const response = await fetch('/api/query', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ query, language: currentLang })
        });
        insights = await response.json();
        container.innerHTML = renderInsightsContent(insights, t);
    } catch (error) {
        container.innerHTML = `<div class="empty-state"><p>Error analyzing data</p></div>`;
    }
}

function renderInsightsContent(data, t) {
    return `
        <div class="insight-card">
            <div class="insight-title">ðŸ’¡ Answer</div>
            <p>${data.answer || ''}</p>
        </div>
        ${data.insights?.length ? `<div class="insight-card"><div class="insight-title">${t.keyFindings}</div><ul class="insight-list">${data.insights.map(i => `<li>${i}</li>`).join('')}</ul></div>` : ''}
        ${data.suggested_charts?.length ? `<div class="insight-card"><div class="insight-title">ðŸ“Š Suggested Charts</div><ul class="insight-list">${data.suggested_charts.map(c => `<li>${c.type}: ${c.description || ''}</li>`).join('')}</ul></div>` : ''}`;
}

function renderChatTab(container, t) {
    container.innerHTML = `
        <div id="chatMessages" class="chat-messages"></div>
        <div class="chat-input-container">
            <input type="text" id="chatInput" class="query-input" placeholder="${t.chatPlaceholder}" onkeypress="if(event.key==='Enter')sendChatMessage()">
            <button class="btn btn-primary" onclick="sendChatMessage()">${t.send}</button>
        </div>`;
    renderChatMessages();
}

function addWelcomeMessage() {
    chatHistory = [{ role: 'assistant', content: i18n[currentLang].welcome }];
}

async function sendChatMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    if (!message) return;
    input.value = '';
    chatHistory.push({ role: 'user', content: message });
    renderChatMessages();
    try {
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ message, language: currentLang, history: chatHistory.slice(-10) })
        });
        const data = await response.json();
        chatHistory.push({ role: 'assistant', content: data.response });
        renderChatMessages();
    } catch (error) {
        chatHistory.push({ role: 'assistant', content: 'Error occurred. Please try again.' });
        renderChatMessages();
    }
}

function renderChatMessages() {
    const container = document.getElementById('chatMessages');
    if (!container) return;
    container.innerHTML = chatHistory.map(m => `<div class="message ${m.role}">${m.content.replace(/\n/g, '<br>')}</div>`).join('');
    container.scrollTop = container.scrollHeight;
}
